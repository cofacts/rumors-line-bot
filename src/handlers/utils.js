export function createPostbackAction(label, input, issuedAt) {
  return {
    type: 'postback',
    label,
    data: JSON.stringify({
      input,
      issuedAt,
    }),
  };
}

/**
 * @param {number} positive - Count of positive feedbacks
 * @param {number} negative - Count of negative feedbacks
 * @return {string} Description of feedback counts
 */
export function createFeedbackWords(positive, negative) {
  if (positive + negative === 0) return '[é‚„æ²’æœ‰äººé‡å°æ­¤å›æ‡‰è©•åƒ¹]';
  let result = '';
  if (positive) result += `æœ‰ ${positive} äººè¦ºå¾—æ­¤å›æ‡‰æœ‰å¹«åŠ©\n`;
  if (negative) result += `æœ‰ ${negative} äººè¦ºå¾—æ­¤å›æ‡‰æ²’å¹«åŠ©\n`;
  return `[${result.trim()}]`;
}

/**
 * @param {string} text - The text to show in flex message, text type
 * @return {string} The truncated text
 */
export function createFlexMessageText(text = '') {
  // Actually the upper limit is 2000, but 100 should be enough
  // because we only show the first line
  return text.slice(0, 100);
}

export function createTypeWords(type) {
  switch (type) {
    case 'RUMOR':
      return 'âŒ å«æœ‰ä¸å¯¦è¨Šæ¯';
    case 'NOT_RUMOR':
      return 'â­• å«æœ‰çœŸå¯¦è¨Šæ¯';
    case 'OPINIONATED':
      return 'ğŸ’¬ å«æœ‰å€‹äººæ„è¦‹';
    case 'NOT_ARTICLE':
      return 'âš ï¸ï¸ ä¸åœ¨æŸ¥è­‰ç¯„åœ';
  }
  return 'å›æ‡‰çš„ç‹€æ…‹æœªå®šç¾©ï¼';
}

/**
 * @param {object} reply The reply object
 * @param {string} reply.reference
 * @param {string} reply.type
 * @returns {string} The reference message to send
 */
export function createReferenceWords({ reference, type }) {
  const prompt = type === 'OPINIONATED' ? 'ä¸åŒè§€é»è«‹è¦‹' : 'å‡ºè™•';

  if (reference) return `${prompt}ï¼š${reference}`;
  return `\uDBC0\uDC85 âš ï¸ï¸ æ­¤å›æ‡‰æ²’æœ‰${prompt}ï¼Œè«‹è‡ªè¡Œæ–Ÿé…Œå›æ‡‰ä¹‹å¯ä¿¡åº¦ã€‚âš ï¸ï¸  \uDBC0\uDC85`;
}

/**
 * prefilled text for reasons
 */
export const REASON_PLACEHOLDER = 'å› ç‚ºâ‹¯â‹¯';

/**
 * @param {number} issuedAt The "issuedAt" to put in postback action
 * @returns {array} an array of reply message instances
 */
export function createAskArticleSubmissionReply(issuedAt) {
  const altText =
    'ã€é€å‡ºè¨Šæ¯åˆ°å…¬é–‹è³‡æ–™åº«ï¼Ÿã€‘\n' +
    'è‹¥é€™æ˜¯ã€Œè½‰å‚³è¨Šæ¯ã€ï¼Œè€Œä¸”æ‚¨è¦ºå¾—é€™å¾ˆå¯èƒ½æ˜¯ä¸€å‰‡ã€Œè¬ è¨€ã€ï¼Œè«‹å°‡é€™å‰‡è¨Šæ¯é€é€²å…¬é–‹è³‡æ–™åº«å»ºæª”ï¼Œè®“å¥½å¿ƒäººæŸ¥è­‰èˆ‡å›è¦†ã€‚\n' +
    '\n' +
    'é›–ç„¶æ‚¨ä¸æœƒç«‹åˆ»æ”¶åˆ°æŸ¥è­‰çµæœï¼Œä½†å¯ä»¥å¹«åŠ©åˆ°æœªä¾†åŒæ¨£æ”¶åˆ°é€™ä»½è¨Šæ¯çš„äººã€‚\n' +
    '\n' +
    'è«‹æŒ‰å·¦ä¸‹è§’ã€ŒâŒ¨ï¸ã€éˆ•ï¼ŒæŠŠã€Œç‚ºä½•æ‚¨æœƒè¦ºå¾—é€™æ˜¯ä¸€å‰‡è¬ è¨€ã€çš„ç†ç”±å‚³çµ¦æˆ‘å€‘ï¼Œå¹«åŠ©é—¢è¬ ç·¨è¼¯é‡æ¸…æ‚¨æœ‰ç–‘æƒ‘ä¹‹è™•ã€‚' +
    '\n' +
    'è‹¥æƒ³æ”¾æ£„ï¼Œè«‹è¼¸å…¥ã€Œnã€ã€‚';
  const accountName = process.env.LINE_AT_ID || 'cofacts';

  return [
    {
      type: 'flex',
      altText,
      contents: {
        type: 'bubble',
        header: {
          type: 'box',
          layout: 'horizontal',
          contents: [
            {
              type: 'text',
              text: 'é€å‡ºè¨Šæ¯åˆ°å…¬é–‹è³‡æ–™åº«ï¼Ÿ',
              weight: 'bold',
              color: '#009900',
              size: 'sm',
            },
          ],
        },
        body: {
          type: 'box',
          layout: 'vertical',
          spacing: 'md',
          contents: [
            {
              type: 'text',
              text:
                'è‹¥é€™æ˜¯ã€Œè½‰å‚³è¨Šæ¯ã€ï¼Œè€Œä¸”æ‚¨è¦ºå¾—é€™å¾ˆå¯èƒ½æ˜¯ä¸€å‰‡ã€Œè¬ è¨€ã€ï¼Œè«‹å°‡é€™å‰‡è¨Šæ¯é€é€²å…¬é–‹è³‡æ–™åº«å»ºæª”ï¼Œè®“å¥½å¿ƒäººæŸ¥è­‰èˆ‡å›è¦†ã€‚',
              wrap: true,
              size: 'xxs',
            },
            {
              type: 'text',
              text:
                'é›–ç„¶æ‚¨ä¸æœƒç«‹åˆ»æ”¶åˆ°æŸ¥è­‰çµæœï¼Œä½†å¯ä»¥å¹«åŠ©åˆ°æœªä¾†åŒæ¨£æ”¶åˆ°é€™ä»½è¨Šæ¯çš„äººã€‚',
              wrap: true,
              size: 'xxs',
            },
            {
              type: 'text',
              text: 'è«‹æ‰“å­—å‘Šè¨´æˆ‘å€‘ï¼š',
              weight: 'bold',
              wrap: true,
              color: '#990000',
              size: 'md',
            },
            {
              type: 'text',
              text: 'ç‚ºä½•æ‚¨æœƒè¦ºå¾—é€™æ˜¯ä¸€å‰‡è¬ è¨€ï¼Ÿ',
              weight: 'bold',
              color: '#ff0000',
              wrap: true,
              size: 'xxl',
            },
          ],
        },
        footer: {
          type: 'box',
          layout: 'vertical',
          contents: [
            {
              type: 'button',
              action: createPostbackAction('æ”¾æ£„é€å‡º', 'n', issuedAt),
            },
            {
              type: 'button',
              style: 'primary',
              action: {
                type: 'uri',
                label: 'âŒ¨ï¸ å‚³ç†ç”±çµ¦æˆ‘å€‘',
                uri: `line://oaMessage/@${accountName}/?${encodeURIComponent(
                  REASON_PLACEHOLDER
                )}`,
              },
            },
          ],
        },
      },
    },
  ];
}

export function isNonsenseText(text) {
  return text.length < 20;
}

const ELLIPSIS = 'â‹¯â‹¯';

/**
 * @param {string} text
 * @param {number} limit
 * @return {string} if the text length is lower than limit, return text; else, return
 *                  text with ellipsis.
 */
export function ellipsis(text, limit) {
  if (text.length < limit) return text;

  return text.slice(0, limit - ELLIPSIS.length) + ELLIPSIS;
}

const SITE_URL = process.env.SITE_URL || 'https://cofacts.g0v.tw';

/**
 * @param {string} articleId
 * @returns {string} The article's full URL
 */
export function getArticleURL(articleId) {
  return `${SITE_URL}/article/${articleId}`;
}
